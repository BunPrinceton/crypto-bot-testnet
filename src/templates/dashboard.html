<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Bot - Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .status-item strong {
            color: #ffd700;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #2a5298;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .price-bid { color: #e74c3c; font-weight: 600; }
        .price-ask { color: #27ae60; font-weight: 600; }
        .price-last { color: #3498db; font-weight: 600; }

        .opportunity {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .opportunity-header {
            font-size: 1.1em;
            font-weight: 600;
            color: #155724;
            margin-bottom: 10px;
        }

        .opportunity-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.95em;
        }

        .opportunity-detail {
            padding: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 3px;
        }

        .profit-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .no-opportunities {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .error {
            color: #e74c3c;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .update-indicator.show {
            opacity: 1;
        }

        .exchange-logo {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            vertical-align: middle;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="update-indicator" id="updateIndicator">Updated</div>

    <div class="container">
        <header>
            <h1>ðŸ¤– Crypto Arbitrage Bot</h1>
            <p style="font-size: 1.2em; margin-top: 10px;">Real-Time Dashboard</p>
            <div class="status-bar">
                <div class="status-item">
                    <strong>Symbol:</strong> {{ symbol }}
                </div>
                <div class="status-item">
                    <strong>Fee:</strong> {{ fee_percent }}%
                </div>
                <div class="status-item">
                    <strong>Update:</strong> <span id="updateInterval">{{ update_interval }}</span>s
                </div>
                <div class="status-item">
                    <strong>Last Update:</strong> <span id="lastUpdate" class="pulse">Loading...</span>
                </div>
                <div class="status-item">
                    <strong>Iteration:</strong> <span id="iteration">-</span>
                </div>
            </div>
        </header>

        <div class="grid">
            <!-- Prices Card -->
            <div class="card">
                <h2>ðŸ“Š Live Prices - {{ symbol }}</h2>
                <div id="pricesContainer">
                    <div class="loading">Loading prices...</div>
                </div>
            </div>

            <!-- Opportunities Card -->
            <div class="card">
                <h2>ðŸŽ¯ Arbitrage Opportunities</h2>
                <div id="opportunitiesContainer">
                    <div class="loading">Scanning for opportunities...</div>
                </div>
            </div>
        </div>

        <!-- Stats Card (full width) -->
        <div class="card">
            <h2>ðŸ“ˆ Statistics</h2>
            <div id="statsContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="statsBody">
                        <tr><td colspan="2" class="loading">Loading stats...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>Crypto Arbitrage Bot v1.0 | Auto-refreshing every {{ update_interval }} seconds</p>
            <p style="margin-top: 10px; font-size: 0.85em;">Demo Dashboard for Presentation</p>
        </footer>
    </div>

    <script>
        const UPDATE_INTERVAL = {{ update_interval }} * 1000; // Convert to milliseconds
        let lastDataHash = null;

        function showUpdateIndicator() {
            const indicator = document.getElementById('updateIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }

        function formatPrice(price) {
            if (price === null || price === undefined) return 'N/A';
            return '$' + price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatPercent(pct) {
            if (pct === null || pct === undefined) return 'N/A';
            return pct.toFixed(3) + '%';
        }

        function renderPrices(prices) {
            if (!prices || Object.keys(prices).length === 0) {
                return '<div class="loading">No price data available</div>';
            }

            let html = '<table><thead><tr><th>Exchange</th><th>Bid</th><th>Ask</th><th>Last</th></tr></thead><tbody>';

            for (const [exchange, data] of Object.entries(prices)) {
                if (data) {
                    html += `
                        <tr>
                            <td><strong>${exchange}</strong></td>
                            <td class="price-bid">${formatPrice(data.bid)}</td>
                            <td class="price-ask">${formatPrice(data.ask)}</td>
                            <td class="price-last">${formatPrice(data.last)}</td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr>
                            <td><strong>${exchange}</strong></td>
                            <td colspan="3" class="error">Error fetching data</td>
                        </tr>
                    `;
                }
            }

            html += '</tbody></table>';
            return html;
        }

        function renderOpportunities(opportunities) {
            if (!opportunities || opportunities.length === 0) {
                return '<div class="no-opportunities">âœ… No profitable arbitrage opportunities found<br><small>(This is normal - arbitrage windows are rare and brief)</small></div>';
            }

            let html = '';
            opportunities.forEach((opp, index) => {
                html += `
                    <div class="opportunity">
                        <div class="opportunity-header">
                            Opportunity #${index + 1} <span class="profit-badge">+${formatPercent(opp.net_profit_pct)}</span>
                        </div>
                        <div class="opportunity-details">
                            <div class="opportunity-detail">
                                <strong>Buy from:</strong> ${opp.buy_from}<br>
                                <strong>Price:</strong> ${formatPrice(opp.buy_price)}
                            </div>
                            <div class="opportunity-detail">
                                <strong>Sell to:</strong> ${opp.sell_to}<br>
                                <strong>Price:</strong> ${formatPrice(opp.sell_price)}
                            </div>
                            <div class="opportunity-detail">
                                <strong>Gross Profit:</strong> ${formatPercent(opp.gross_profit_pct)}
                            </div>
                            <div class="opportunity-detail">
                                <strong>Net Profit:</strong> ${formatPercent(opp.net_profit_pct)}
                            </div>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function renderStats(data) {
            if (!data || !data.prices) {
                return '<tr><td colspan="2" class="loading">No stats available</td></tr>';
            }

            const prices = data.prices;
            const validPrices = Object.values(prices).filter(p => p !== null);

            if (validPrices.length === 0) {
                return '<tr><td colspan="2" class="error">No valid price data</td></tr>';
            }

            const lastPrices = validPrices.map(p => p.last);
            const avgPrice = lastPrices.reduce((a, b) => a + b, 0) / lastPrices.length;
            const minPrice = Math.min(...lastPrices);
            const maxPrice = Math.max(...lastPrices);
            const spread = ((maxPrice - minPrice) / minPrice * 100);

            return `
                <tr>
                    <td><strong>Exchanges Online</strong></td>
                    <td>${validPrices.length} / ${Object.keys(prices).length}</td>
                </tr>
                <tr>
                    <td><strong>Average Price</strong></td>
                    <td>${formatPrice(avgPrice)}</td>
                </tr>
                <tr>
                    <td><strong>Lowest Price</strong></td>
                    <td>${formatPrice(minPrice)}</td>
                </tr>
                <tr>
                    <td><strong>Highest Price</strong></td>
                    <td>${formatPrice(maxPrice)}</td>
                </tr>
                <tr>
                    <td><strong>Price Spread</strong></td>
                    <td>${formatPercent(spread)}</td>
                </tr>
                <tr>
                    <td><strong>Opportunities Found</strong></td>
                    <td>${data.opportunities ? data.opportunities.length : 0}</td>
                </tr>
            `;
        }

        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();

                // Check if data actually changed
                const currentHash = JSON.stringify(data);
                if (currentHash !== lastDataHash) {
                    lastDataHash = currentHash;
                    showUpdateIndicator();

                    // Update prices
                    document.getElementById('pricesContainer').innerHTML = renderPrices(data.prices);

                    // Update opportunities
                    document.getElementById('opportunitiesContainer').innerHTML = renderOpportunities(data.opportunities);

                    // Update stats
                    document.getElementById('statsBody').innerHTML = renderStats(data);

                    // Update status bar
                    document.getElementById('lastUpdate').textContent = data.last_update || 'N/A';
                    document.getElementById('iteration').textContent = data.iteration || '-';
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('pricesContainer').innerHTML = '<div class="error">Error loading data</div>';
            }
        }

        // Initial fetch
        fetchData();

        // Set up auto-refresh
        setInterval(fetchData, UPDATE_INTERVAL);

        console.log('ðŸ¤– Crypto Arbitrage Bot Dashboard loaded');
        console.log('Auto-refreshing every', UPDATE_INTERVAL / 1000, 'seconds');
    </script>
</body>
</html>
